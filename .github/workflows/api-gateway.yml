name: API Gateway CI/CD

on:
  push:
    paths:
      - 'api-gateway/**'
      - '.github/workflows/api-gateway.yml'
  pull_request:
    paths:
      - 'api-gateway/**'

env:
  HELM_VERSION: 3.12.0

jobs:
  helm-deploy:
    runs-on: ubuntu-latest
    name: Deploy with Helm
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - run: helm lint ./helm/ecommerce

      - run: |
          helm template my-ecommerce ./helm/ecommerce \
              -f ./helm/ecommerce/values.yaml \
              --set global.targetEnvironment=dev > helm-rendered.yaml

      - uses: actions/upload-artifact@v3
        with:
          name: api-gateway-template
          path: helm-rendered.yaml

      - run: |
          helm upgrade --install my-ecommerce ./helm/ecommerce \
              -f ./helm/ecommerce/values.yaml \
              --set global.targetEnvironment=dev \
              --namespace ecommerce-dev \
              --create-namespace \
              --wait \
              --timeout 5m

  notify:
    runs-on: ubuntu-latest
    needs: helm-deploy
    if: always()
    steps:
      - run: |
          if [ "${{ needs.helm-deploy.result }}" = "failure" ]; then exit 1; fi
          echo "âœ” Deployment successful!"

name: Cloud config CI (Kind + Helm)

on:
  push:
    paths:
      - 'shipping-service/**'
      - 'helm/**'
      - '.github/workflows/shipping-service.yml'
  pull_request:
    paths:
      - 'shipping-service/**'
      - 'helm/**'

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0

jobs:
  ci-kind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Helm
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      # Install Kind
      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      # Create Kind cluster
      - name: Create cluster
        run: |
          kind create cluster --name ci-cluster --wait 60s

      - name: Update Helm dependencies
        run: |
          helm dependency update ./helm/ecommerce

      - name: Helm lint
        run: |
          helm lint ./helm/ecommerce

      # Render template
      - name: Render Helm template
        run: |
          helm template my-ecommerce ./helm/ecommerce \
            -f ./helm/ecommerce/values.yaml \
            --set global.targetEnvironment=dev \
            > helm-rendered.yaml

      # Upload rendered template
      - name: Upload helm template
        uses: actions/upload-artifact@v4
        with:
          name: rendered-template
          path: helm-rendered.yaml

      # Deploy into Kind
      - name: Helm install into Kind
        run: |
          kubectl create namespace ecommerce || true
          helm upgrade --install my-ecommerce ./helm/ecommerce \
            -n ecommerce \
            -f ./helm/ecommerce/values.yaml \
            --set global.targetEnvironment=dev \
            --wait --timeout 3m

      # Verify deployments
      - name: Verify pods running
        run: |
          kubectl get pods -n ecommerce
          kubectl wait --for=condition=Ready pod --all -n ecommerce --timeout=60s

      # Destroy cluster
      - name: Delete kind cluster
        if: always()
        run: |
          kind delete cluster --name ci-cluster

name: Ecommerce CI/CD (Minikube Local)

on:
  push:
  pull_request:
    branches: [ main, develop, dev, qa, prod ]

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  # ============================================
  # 0. SET IMAGE TAG AND VALUES FILE
  # ============================================
  set-env:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
      VALUES_FILE: ${{ steps.set-tag.outputs.VALUES_FILE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag and values file
        id: set-tag
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch is $BRANCH_NAME"

          IMAGE_TAG="dev"
          VALUES_FILE="./helm/ecommerce/values-dev.yaml"

          if [[ "$BRANCH_NAME" == "dev" ]]; then
            IMAGE_TAG="dev"
            VALUES_FILE="./helm/ecommerce/values-dev.yaml"
          elif [[ "$BRANCH_NAME" == "qa" ]]; then
            IMAGE_TAG="qa"
            VALUES_FILE="./helm/ecommerce/values-qa.yaml"
          elif [[ "$BRANCH_NAME" == "prod" ]]; then
            IMAGE_TAG="prod"
            VALUES_FILE="./helm/ecommerce/values-prod.yaml"
          else
            IMAGE_TAG="$BRANCH_NAME"
            VALUES_FILE="./helm/ecommerce/values-dev.yaml"
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "VALUES_FILE=$VALUES_FILE" >> $GITHUB_OUTPUT

  # ============================================
  # 1. BUILD MAVEN (CI)
  # ============================================
  build-services:
    runs-on: ubuntu-latest
    needs: set-env
    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build ${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven

      - name: Build ${{ matrix.service }}
        run: |
          if [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn clean package -DskipTests
          else
            echo "Skipping ${{ matrix.service }} - not a Maven service"
          fi

      - name: Run tests for ${{ matrix.service }}
        run: |
          if [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn test
          fi

      - name: Upload build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ${{ matrix.service }}/target/*.jar  

  # ============================================
  # 2. BUILD DOCKER IMAGES & PUSH
  # ============================================
  build-docker-images:
    needs: [build-services, set-env]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build Docker Image - ${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -f "${{ matrix.service }}/pom.xml" ]; then
            VERSION=$(grep '<version>' ${{ matrix.service }}/pom.xml | head -n1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="latest"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ./${{ matrix.service }}/target/

      - name: Verify JAR
        run: |
          ls -lah ${{ matrix.service }}/target/
          if ! ls ${{ matrix.service }}/target/*.jar 1> /dev/null 2>&1; then
            echo "JAR not found"
            exit 1
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.set-env.outputs.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:latest

  # ============================================
  # 3. VALIDATE HELM CHARTS
  # ============================================
  validate-charts:
    needs: build-docker-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Validate ${{ matrix.service }} Helm Chart
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm lint ${{ matrix.service }}
        run: |
          if [ -d "helm/ecommerce/charts/${{ matrix.service }}" ]; then
            helm lint ./helm/ecommerce/charts/${{ matrix.service }} \
              -f ${{ needs.set-env.outputs.VALUES_FILE }} \
              --set global.targetEnvironment=${{ needs.set-env.outputs.IMAGE_TAG }}
          fi

      - name: Render Helm template ${{ matrix.service }}
        run: |
          if [ -d "helm/ecommerce/charts/${{ matrix.service }}" ]; then
            helm template ${{ matrix.service }} ./helm/ecommerce/charts/${{ matrix.service }} \
              -f ${{ needs.set-env.outputs.VALUES_FILE }} \
              --set global.targetEnvironment=${{ needs.set-env.outputs.IMAGE_TAG }} \
              > helm-${{ matrix.service }}-rendered.yaml
          fi

  # ============================================
  # 4. DEPLOY & TEST ALL SERVICES
  # ============================================
  deploy-and-test:
    needs: [validate-charts, set-env]
    runs-on: ubuntu-latest
    name: Deploy & Test All Services
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      - name: Create Kind cluster
        run: |
          kind create cluster --name ecommerce-ci --wait 60s

      - name: Helm deploy ecommerce
        run: |
          helm upgrade --install my-ecommerce ./helm/ecommerce \
            -f ${{ needs.set-env.outputs.VALUES_FILE }} \
            --set global.targetEnvironment=${{ needs.set-env.outputs.IMAGE_TAG }}

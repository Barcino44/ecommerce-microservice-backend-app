name: Ecommerce CI/CD (Minikube Local)

on:
  push:  
  pull_request:
    branches: [ main, develop ]

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  # ============================================
  # 1. BUILD MAVEN (CI)
  # ============================================
  build-services:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - cloud-config
          - service-discovery
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
    
    name: Build ${{ matrix.service }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven

      - name: Build ${{ matrix.service }}
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn clean package -DskipTests
          else
            echo "Skipping ${{ matrix.service }} - not a Maven service"
          fi
        

      - name: Run tests for ${{ matrix.service }}
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn test
          fi
        

      - name: Upload build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ${{ matrix.service }}/target/*.jar
        

  # ============================================
  # 2. VALIDATE HELM CHARTS
  # ============================================
  validate-charts:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - cloud-config
          - service-discovery
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
    
    name: Validate ${{ matrix.service }} Helm Chart
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm lint ${{ matrix.service }}
        run: |
          if [ -d "helm/ecommerce/charts/${{ matrix.service }}" ]; then
            helm lint ./helm/ecommerce/charts/${{ matrix.service }} \
              -f ./helm/ecommerce/values-dev.yaml \
              --set global.targetEnvironment=dev
          fi
        

      - name: Render Helm template ${{ matrix.service }}
        run: |
          if [ -d "helm/ecommerce/charts/${{ matrix.service }}" ]; then
            helm template ${{ matrix.service }} ./helm/ecommerce/charts/${{ matrix.service }} \
              -f ./helm/ecommerce/values-dev.yaml \
              --set global.targetEnvironment=dev \
              > helm-${{ matrix.service }}-rendered.yaml
          fi
        

  # ============================================
  # 3. BUILD DOCKER IMAGES & PUSH
  # ============================================
build-docker-images:
  needs: build-services
  if: github.event_name == 'push'
  runs-on: ubuntu-latest
  strategy:
    matrix:
      service:
        - user-service
        - product-service
        - payment-service
        - shipping-service
        - favourite-service
        - api-gateway
  
  name: Build Docker Image - ${{ matrix.service }}
  
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1️⃣ PRIMERO: Extraer versión
    - name: Extract version
      id: version
      run: |
        if [ -f "${{ matrix.service }}/pom.xml" ]; then
          VERSION=$(grep '<version>' ${{ matrix.service }}/pom.xml | head -n1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        else
          VERSION="latest"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        fi

    # 2️⃣ SEGUNDO: Setup Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3️⃣ TERCERO: Download artifact
    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.service }}-build
        path: ${{ matrix.service }}/target/

    # 4️⃣ CUARTO: Verificar JAR
    - name: List downloaded files
      run: |
        echo "Checking if JAR exists:"
        ls -lh ${{ matrix.service }}/target/ || echo "❌ Target directory is empty or missing!"

    # 5️⃣ QUINTO: Login a Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_PASSWORD }}

    # 6️⃣ SEXTO: Build and push (SIN caché de GHA)
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./${{ matrix.service }}
        push: true
        tags: |
          ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ steps.version.outputs.VERSION }}
          ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:latest
        

  # ============================================
  # 4. DEPLOY & TEST (Kind Cluster - CI)
  # ============================================
  deploy-and-test-ci:
    needs: [build-services, validate-charts]
    runs-on: ubuntu-latest
    name: Test in Kind Cluster (CI)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      - name: Create Kind cluster
        run: |
          kind create cluster --name ecommerce-ci --wait 60s
          kubectl cluster-info
          kubectl get nodes

      - name: Create dev namespace
        run: kubectl create namespace dev || true

      - name: Deploy services with Helm
        run: |
          helm upgrade --install my-ecommerce ./helm/ecommerce \
            -f ./helm/ecommerce/values-dev.yaml \
            --set global.targetEnvironment=dev \
            -n dev
        

      - name: Wait for services
        run: |
          echo "Waiting for Service Discovery..."
          kubectl wait --for=condition=Ready pod -l app=service-discovery -n dev --timeout=180s 2>&1 || true
          sleep 40
          
          echo "Waiting for all services..."
          kubectl wait --for=condition=Ready pod --all -n dev --timeout=180s 2>&1 || true
          sleep 60

      - name: Check deployment status
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -o wide -n dev
          echo ""
          echo "=== Services ==="
          kubectl get svc -n dev

      - name: Run health checks
        
        run: |
          kubectl run test-pod -n dev --image=curlimages/curl:latest --restart=Never --command -- sleep 3600
          kubectl wait -n dev --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Testing User Service..."
          kubectl exec test-pod -n dev -- curl -s http://my-ecommerce-user-service.dev.svc.cluster.local:8700/actuator/health || true
          
          echo "Testing API Gateway..."
          kubectl exec test-pod -n dev -- curl -s http://my-ecommerce-api-gateway.dev.svc.cluster.local:8080/actuator/health || true

      - name: Cleanup
        if: always()
        run: kind delete cluster --name ecommerce-ci || true

  # ============================================
  # 6. SUMMARY
  # ============================================
  summary:
    if: always()
    needs: [build-services, validate-charts, deploy-and-test-ci]
    runs-on: ubuntu-latest
    name: Pipeline Summary
    
    steps:
      - name: Print summary
        run: |
          echo "=== Pipeline Execution Summary ==="
          echo "Build Status: ${{ needs.build-services.result }}"
          echo "Helm Validation: ${{ needs.validate-charts.result }}"
          echo "CI Testing: ${{ needs.deploy-and-test-ci.result }}"
          echo "Overall Status: ${{ job.status }}"
          echo ""
          echo "✅ Listo para desplegar en Minikube local"
name: Ecommerce CI/CD (Validate + Deploy + Test Endpoints)

on:
  push:
  pull_request:

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0

jobs:
  validate-charts:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [cloud-config, service-discovery, shipping-service, product-service, proxy-client, user-service, payment-service, order-service, favourite-service, zipkin, api-gateway]
    name: Validate ${{ matrix.service }} Chart

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm lint ${{ matrix.service }}
        run: |
          helm lint ./helm/ecommerce/charts/${{ matrix.service }}

      - name: Render Helm template ${{ matrix.service }}
        run: |
          helm template ${{ matrix.service }} ./helm/ecommerce/charts/${{ matrix.service }} \
            -f ./helm/ecommerce/charts/${{ matrix.service }}/values.yaml \
            --set global.targetEnvironment=dev \
            > helm-${{ matrix.service }}-rendered.yaml

      - name: Upload rendered template
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-helm-template
          path: helm-${{ matrix.service }}-rendered.yaml

  deploy-and-test:
    needs: validate-charts
    runs-on: ubuntu-latest
    name: Deploy & Test All Services

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      - name: Create Kind cluster
        run: |
          kind create cluster --name ecommerce-ci --wait 60s

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      # ===== DEPLOYMENT PHASE =====
      - name: Helm deploy ecommerce
        run: |
          helm upgrade --install my-ecommerce ./helm/ecommerce \
            -f ./helm/ecommerce/values.yaml \
            --set global.targetEnvironment=dev

      - name: Wait for pods to be created
        run: |
          echo "Waiting for pods to be created..."
          sleep 15
          kubectl get pods -o wide

      # ===== EUREKA REGISTRATION PHASE =====
      - name: Wait for Service Discovery (Eureka) first
        continue-on-error: true
        run: |
          echo "=== Waiting for Service Discovery (Eureka) to be Ready ==="
          kubectl wait --for=condition=Ready pod -l app=service-discovery --timeout=180s 2>&1 || echo "service-discovery: timeout"
          
          echo "Waiting 40s for Eureka to fully initialize..."
          sleep 40

      - name: Wait for Cloud Config
        continue-on-error: true
        run: |
          echo "=== Waiting for Cloud Config to be Ready ==="
          kubectl wait --for=condition=Ready pod -l app=cloud-config --timeout=180s 2>&1 || echo "cloud-config: timeout"
          
          echo "Waiting 30s for Cloud Config to register with Eureka..."
          sleep 30

      - name: Wait for all other services to be Ready
        continue-on-error: true
        run: |
          echo "=== Waiting for all pods to be Ready ==="
          kubectl wait --for=condition=Ready pod --all --timeout=180s 2>&1 || echo "Some pods not ready"
          
          echo ""
          echo "Waiting 90s for all services to register with Eureka..."
          sleep 90

      - name: Verify deployment status
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -o wide
          echo ""
          echo "=== Services ==="
          kubectl get svc
          echo ""
          echo "=== Deployments ==="
          kubectl get deployments

      - name: Check Eureka registry
        continue-on-error: true
        run: |
          echo "=== Checking Eureka Service Registry ==="
          kubectl port-forward svc/my-ecommerce-service-discovery 8761:8761 &
          sleep 2
          
          echo "Registered services in Eureka:"
          curl -s http://localhost:8761/eureka/apps | grep -o "<n>[^<]*</n>" | sed 's/<[^>]*>//g' | sort | uniq || echo "Could not fetch Eureka registry"
          
          pkill -f "port-forward" || true

      # ===== TESTING PHASE =====
      - name: Test Cloud Config
        continue-on-error: true
        run: |
          echo "Testing Cloud Config (port 9296)..."
          kubectl port-forward svc/my-ecommerce-cloud-config 9296:9296 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:9296/actuator/health || echo "Cloud Config: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Service Discovery
        continue-on-error: true
        run: |
          echo "Testing Service Discovery (port 8761)..."
          kubectl port-forward svc/my-ecommerce-service-discovery 8761:8761 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8761/actuator/health || echo "Service Discovery: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test API Gateway
        continue-on-error: true
        run: |
          echo "Testing API Gateway (port 8080)..."
          kubectl port-forward svc/my-ecommerce-api-gateway 8080:8080 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8080/actuator/health || echo "API Gateway: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test User Service
        continue-on-error: true
        run: |
          echo "Testing User Service (port 8700)..."
          kubectl port-forward svc/my-ecommerce-user-service 8700:8700 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8700/actuator/health || echo "User Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Product Service
        continue-on-error: true
        run: |
          echo "Testing Product Service (port 8500)..."
          kubectl port-forward svc/my-ecommerce-product-service 8500:8500 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8500/actuator/health || echo "Product Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Order Service
        continue-on-error: true
        run: |
          echo "Testing Order Service (port 8300)..."
          kubectl port-forward svc/my-ecommerce-order-service 8300:8300 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8300/actuator/health || echo "Order Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Payment Service
        continue-on-error: true
        run: |
          echo "Testing Payment Service (port 8400)..."
          kubectl port-forward svc/my-ecommerce-payment-service 8400:8400 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8400/actuator/health || echo "Payment Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Shipping Service
        continue-on-error: true
        run: |
          echo "Testing Shipping Service (port 8600)..."
          kubectl port-forward svc/my-ecommerce-shipping-service 8600:8600 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8600/actuator/health || echo "Shipping Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Proxy Client
        continue-on-error: true
        run: |
          echo "Testing Proxy Client (port 8900)..."
          kubectl port-forward svc/my-ecommerce-proxy-client 8900:8900 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8900/actuator/health || echo "Proxy Client: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Favourite Service
        continue-on-error: true
        run: |
          echo "Testing Favourite Service (port 8800)..."
          kubectl port-forward svc/my-ecommerce-favourite-service 8800:8800 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:8800/actuator/health || echo "Favourite Service: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      - name: Test Zipkin
        continue-on-error: true
        run: |
          echo "Testing Zipkin (port 9411)..."
          kubectl port-forward svc/my-ecommerce-zipkin 9411:9411 &
          sleep 2
          curl -s -w "\nHTTP Status: %{http_code}\n" http://localhost:9411/health || echo "Zipkin: unavailable"
          pkill -f "port-forward" || true
          sleep 1

      # ===== SUMMARY PHASE =====
      - name: Final summary
        if: always()
        run: |
          echo "=== Final Pod Status ==="
          kubectl get pods -o wide
          echo ""
          echo "=== Final Services ==="
          kubectl get svc
          echo ""
          echo "=== Final Deployments ==="
          kubectl get deployments
          echo ""
          echo "=== Cluster Events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -20

      - name: Delete Kind cluster
        if: always()
        run: |
          kind delete cluster --name ecommerce-ci
name: Ecommerce CI/CD (Helmfile)

on:
  push:
  pull_request:
    branches: [ master, dev ]

env:
  HELM_VERSION: 3.12.0
  HELMFILE_VERSION: 0.157.0
  KIND_VERSION: v0.20.0
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  # ============================================
  # 0. SET IMAGE TAG AND ENVIRONMENT
  # ============================================
  set-env:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
      ENVIRONMENT: ${{ steps.set-tag.outputs.ENVIRONMENT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag and environment
        id: set-tag
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch is $BRANCH_NAME"

          # Convert branch name to valid Docker tag
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          echo "SAFE_BRANCH_NAME=$SAFE_BRANCH_NAME"

          IMAGE_TAG="dev"
          ENVIRONMENT="dev"

          if [[ "$SAFE_BRANCH_NAME" == "dev" ]]; then
            IMAGE_TAG="dev"
            ENVIRONMENT="dev"
          elif [[ "$SAFE_BRANCH_NAME" == "qa" ]]; then
            IMAGE_TAG="qa"
            ENVIRONMENT="qa"
          elif [[ "$SAFE_BRANCH_NAME" == "prod" ]]; then
            IMAGE_TAG="prod"
            ENVIRONMENT="prod"
          else
            IMAGE_TAG="$SAFE_BRANCH_NAME"
            ENVIRONMENT="dev"
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_OUTPUT

  # ============================================
  # 1. BUILD MAVEN (CI) - CONDITIONAL
  # ============================================
  build-services:
    runs-on: ubuntu-latest
    needs: set-env
    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build ${{ matrix.service }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if service changed
        id: changed
        run: |
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ First commit or no previous commit, building ${{ matrix.service }}"
          else
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.service }}/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "✅ ${{ matrix.service }} has changes"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "⏭️  ${{ matrix.service }} has NO changes, skipping"
            fi
          fi

      - name: Set up JDK 11
        if: steps.changed.outputs.changed == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven

      - name: Build ${{ matrix.service }}
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn clean package -DskipTests
          else
            echo "Skipping ${{ matrix.service }} - not a Maven service"
          fi

      - name: Run tests for ${{ matrix.service }}
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            mvn test
          fi

      - name: Upload build artifact
        if: steps.changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ${{ matrix.service }}/target/*.jar  

  # ============================================
  # 2. BUILD DOCKER IMAGES & PUSH - CONDITIONAL
  # ============================================
  build-docker-images:
    needs: [build-services, set-env]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build Docker Image - ${{ matrix.service }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if service changed
        id: changed
        run: |
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ First commit or no previous commit, building Docker image for ${{ matrix.service }}"
          else
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.service }}/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "✅ ${{ matrix.service }} has changes, will build Docker image"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "⏭️  ${{ matrix.service }} has NO changes, skipping Docker build"
            fi
          fi

      - name: Extract version
        if: steps.changed.outputs.changed == 'true'
        id: version
        run: |
          if [ -f "${{ matrix.service }}/pom.xml" ]; then
            VERSION=$(grep '<version>' ${{ matrix.service }}/pom.xml | head -n1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="latest"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.changed.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Download build artifact
        if: steps.changed.outputs.changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ./${{ matrix.service }}/target/

      - name: Verify and organize JAR
        if: steps.changed.outputs.changed == 'true'
        run: |
          mkdir -p ${{ matrix.service }}/target/
          if [ -d "artifact-temp" ]; then
            mv artifact-temp/* ${{ matrix.service }}/target/ 2>/dev/null || true
            rmdir artifact-temp
          fi
          ls -lah ${{ matrix.service }}/target/
          if ! ls ${{ matrix.service }}/target/*.jar 1> /dev/null 2>&1; then
            echo "JAR not found"
            exit 1
          fi

      - name: Login to Docker Hub
        if: steps.changed.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        if: steps.changed.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.set-env.outputs.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:latest
      
      - name: Scan Docker image with Trivy
        if: steps.changed.outputs.changed == 'true'
        uses: aquasecurity/trivy-action@0.11.2
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.set-env.outputs.IMAGE_TAG }}
          format: table
          exit-code: 0
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'

  # ============================================
  # 3. VALIDATE HELM CHARTS
  # ============================================
  validate-charts:
    needs: [build-docker-images, set-env]
    runs-on: ubuntu-latest
    name: Validate Helm Charts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Build Helm dependencies for ecommerce chart
        run: |
          cd helm/ecommerce
          helm dependency update

      - name: Helm lint - ecommerce chart
        run: |
          cd helm
          helm lint ./ecommerce \
            -f ./ecommerce/values-${{ needs.set-env.outputs.ENVIRONMENT }}.yaml

      - name: Helm lint - secrets chart
        run: |
          cd helm
          helm lint ./secrets \
            -f ./ecommerce/values-${{ needs.set-env.outputs.ENVIRONMENT }}.yaml || echo "Secrets lint skipped"

      - name: Helm template - ecommerce chart
        run: |
          cd helm
          helm template my-ecommerce ./ecommerce \
            -f ./ecommerce/values-${{ needs.set-env.outputs.ENVIRONMENT }}.yaml \
            --namespace ${{ needs.set-env.outputs.ENVIRONMENT }} \
            > ecommerce-rendered.yaml

      - name: Upload rendered templates
        uses: actions/upload-artifact@v4
        with:
          name: helm-rendered-templates
          path: helm/ecommerce-rendered.yaml

  # ============================================
  # 4. DEPLOY & TEST WITH HELMFILE
  # ============================================
  deploy-and-test:
    needs: [validate-charts, set-env]
    runs-on: ubuntu-latest
    name: Deploy & Test with Helmfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Helmfile
        run: |
          wget https://github.com/helmfile/helmfile/releases/download/v${{ env.HELMFILE_VERSION }}/helmfile_${{ env.HELMFILE_VERSION }}_linux_amd64.tar.gz
          tar -xzf helmfile_${{ env.HELMFILE_VERSION }}_linux_amd64.tar.gz
          sudo mv helmfile /usr/local/bin/
          helmfile version

      - name: Install Helm Diff plugin
        run: |
          helm plugin install https://github.com/databus23/helm-diff --version v3.8.1

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      - name: Create Kind cluster
        run: |
          kind create cluster --name ecommerce-ci --wait 60s

      - name: Detect service changes and create override values
        id: detect-changes
        run: |
          # Default stable tags
          declare -A TAGS=(
            [service-discovery]="feature-db"
            [cloud-config]="feature-db"
            [api-gateway]="0.1.0"
            [product-service]="0.1.0"
            [user-service]="0.1.0"
            [payment-service]="0.1.0"
            [shipping-service]="0.1.0"
            [favourite-service]="feature-sealedsecret"
            [order-service]="0.1.0"
            [proxy-client]="0.1.0"
          )
          
          # Detect changes and update tags
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            for service in "${!TAGS[@]}"; do
              if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${service}/"; then
                TAGS[$service]="${{ needs.set-env.outputs.IMAGE_TAG }}"
                echo "✅ $service changed, using tag: ${TAGS[$service]}"
              fi
            done
          fi
          
          # Create override values file in helm directory
          cat > helm/override-tags.yaml <<EOF
          service-discovery:
            image:
              tag: "${TAGS[service-discovery]}"
          
          cloud-config:
            image:
              tag: "${TAGS[cloud-config]}"
          
          api-gateway:
            image:
              tag: "${TAGS[api-gateway]}"
          
          product-service:
            image:
              tag: "${TAGS[product-service]}"
          
          user-service:
            image:
              tag: "${TAGS[user-service]}"
          
          payment-service:
            image:
              tag: "${TAGS[payment-service]}"
          
          shipping-service:
            image:
              tag: "${TAGS[shipping-service]}"
          
          favourite-service:
            image:
              tag: "${TAGS[favourite-service]}"
          
          order-service:
            image:
              tag: "${TAGS[order-service]}"
          
          proxy-client:
            image:
              tag: "${TAGS[proxy-client]}"
          EOF
          
          echo "Generated override tags file:"
          cat helm/override-tags.yaml

      - name: Deploy with Helmfile
        run: |
          cd helm
          helmfile -e ${{ needs.set-env.outputs.ENVIRONMENT }} \
            --state-values-file override-tags.yaml \
          helmfile -e dev --state-values-file override-tags.yaml apply
                  
      - name: Wait for pods to be created
        run: |
          echo "Waiting for pods to be created..."
          sleep 15
          kubectl get pods -o wide -n ${{ needs.set-env.outputs.ENVIRONMENT }}

      # ===== EUREKA & CLOUD CONFIG =====

      - name: Wait for Service Discovery (Eureka)
        run: |
          kubectl wait --for=condition=Ready pod -l app=service-discovery -n ${{ needs.set-env.outputs.ENVIRONMENT }} --timeout=180s || echo "Eureka timeout"
          echo "Waiting 40s for Eureka to fully initialize..."
          sleep 40

      - name: Wait for Cloud Config
        run: |
          kubectl wait --for=condition=Ready pod -l app=cloud-config -n ${{ needs.set-env.outputs.ENVIRONMENT }} --timeout=180s || echo "Cloud Config timeout"
          echo "Waiting 30s for Cloud Config to register with Eureka..."
          sleep 30

      - name: Wait for all other services
        run: |
          kubectl wait --for=condition=Ready pod --all -n ${{ needs.set-env.outputs.ENVIRONMENT }} --timeout=180s || echo "Some pods not ready"
          echo "Waiting 90s for all services to register with Eureka..."
          sleep 90

      - name: Verify deployment status
        run: |
          kubectl get pods -o wide -n ${{ needs.set-env.outputs.ENVIRONMENT }}
          kubectl get svc -n ${{ needs.set-env.outputs.ENVIRONMENT }}
          kubectl get deployments -n ${{ needs.set-env.outputs.ENVIRONMENT }}

      - name: Show Helmfile releases
        run: |
          cd helm
          helmfile -e ${{ needs.set-env.outputs.ENVIRONMENT }} list
          
      - name: Debug Eureka Server
        run: |
          echo "=== Eureka Server Pods ==="
          kubectl get pods -n ${{ needs.set-env.outputs.ENVIRONMENT }} -l app=service-discovery
          
          echo "=== Eureka Server Logs ==="
          kubectl logs -n ${{ needs.set-env.outputs.ENVIRONMENT }} -l app=service-discovery --tail=50 || true
          
          echo "=== Eureka Server Service ==="
          kubectl get svc -n ${{ needs.set-env.outputs.ENVIRONMENT }} -l app=service-discovery

      - name: Debug API Gateway Connection to Eureka
        run: |
          echo "=== API Gateway Pods ==="
          kubectl get pods -n ${{ needs.set-env.outputs.ENVIRONMENT }} -l app=api-gateway
          
          echo "=== API Gateway Logs ==="
          kubectl logs -n ${{ needs.set-env.outputs.ENVIRONMENT }} -l app=api-gateway --tail=100 | grep -i eureka || echo "No Eureka logs found"

      - name: Get service names from Helmfile
        id: get-services
        run: |
          cd helm
          # Obtener el namespace del values file
          NAMESPACE=$(helmfile -e ${{ needs.set-env.outputs.ENVIRONMENT }} template | grep -A 1 "kind: Service" | grep "namespace:" | head -1 | awk '{print $2}' | tr -d '"')
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          
          # Obtener el release name del my-ecommerce
          RELEASE_NAME=$(helmfile -e ${{ needs.set-env.outputs.ENVIRONMENT }} list | grep "my-ecommerce" | awk '{print $1}')
          echo "release-name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          echo "Detected namespace: $NAMESPACE"
          echo "Detected release: $RELEASE_NAME"

      - name: Test Eureka from test pod
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          
          kubectl run test-pod -n $NAMESPACE --image=curlimages/curl:latest --restart=Never --command -- sleep 3600
          kubectl wait -n $NAMESPACE --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "=== Test Eureka Health ==="
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-service-discovery.${NAMESPACE}.svc.cluster.local:8761/actuator/health || true
          
          echo "=== Test Eureka Registry ==="
          kubectl exec test-pod -n $NAMESPACE -- curl -s http://${RELEASE}-service-discovery.${NAMESPACE}.svc.cluster.local:8761/eureka/apps || true

      # === Test endpoints ===
      - name: Test API Gateway
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-api-gateway.${NAMESPACE}.svc.cluster.local:8080/app/api/products || true

      - name: Test Shipping Service
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-shipping-service.${NAMESPACE}.svc.cluster.local:8600/shipping-service/api/shippings || true

      - name: Test User Service
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-user-service.${NAMESPACE}.svc.cluster.local:8700/user-service/api/users || true

      - name: Test Product Service
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-product-service.${NAMESPACE}.svc.cluster.local:8500/product-service/api/products || true

      - name: Test Favourite Service
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-favourite-service.${NAMESPACE}.svc.cluster.local:8800/favourite-service/api/favourites || true

      - name: Test Payment Service
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          RELEASE=${{ steps.get-services.outputs.release-name }}
          kubectl exec test-pod -n $NAMESPACE -- curl -v http://${RELEASE}-payment-service.${NAMESPACE}.svc.cluster.local:8400/payment-service/api/payments || true

      - name: Cleanup test pod
        if: always()
        run: |
          NAMESPACE=${{ steps.get-services.outputs.namespace }}
          kubectl delete pod test-pod -n $NAMESPACE --ignore-not-found
          
      - name: Cleanup on failure
        if: failure()
        run: |
          cd helm
          helmfile -e ${{ needs.set-env.outputs.ENVIRONMENT }} destroy
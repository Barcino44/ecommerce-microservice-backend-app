name: Ecommerce CI/CD (Optimizado)

on:
  push:
    branches-ignore:
      - prod
      - qa
  pull_request:
    branches: [ master, dev ]

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  set-env:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
      VALUES_FILE: ${{ steps.set-tag.outputs.VALUES_FILE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag and values file
        id: set-tag
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          
          IMAGE_TAG="dev"
          VALUES_FILE="./helm/ecommerce/values-dev.yaml"

          if [[ "$SAFE_BRANCH_NAME" == "dev" ]]; then
            IMAGE_TAG="dev"
            VALUES_FILE="./helm/ecommerce/values-dev.yaml"
          else
            IMAGE_TAG="$SAFE_BRANCH_NAME"
            VALUES_FILE="./helm/ecommerce/values-dev.yaml"
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "VALUES_FILE=$VALUES_FILE" >> $GITHUB_OUTPUT

  # OPTIMIZACIÓN 1: Reducir paralelismo con max-parallel
  build-services:
    runs-on: ubuntu-latest
    needs: set-env
    strategy:
      max-parallel: 3  # Solo 3 builds simultáneos en vez de 10
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build ${{ matrix.service }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if service changed
        id: changed
        run: |
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.service }}/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      # OPTIMIZACIÓN 2: Cache de Maven más agresivo
      - name: Cache Maven packages
        if: steps.changed.outputs.changed == 'true'
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set up JDK 11
        if: steps.changed.outputs.changed == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven

      # OPTIMIZACIÓN 3: Build con opciones de memoria
      - name: Build ${{ matrix.service }}
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            # Limitar memoria de Maven
            export MAVEN_OPTS="-Xmx1024m -XX:MaxMetaspaceSize=256m"
            mvn clean package -DskipTests -T 1C  # -T 1C usa 1 thread por core
          fi

      - name: Run tests for ${{ matrix.service }}
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ -d "${{ matrix.service }}" ] && [ -f "${{ matrix.service }}/pom.xml" ]; then
            cd ${{ matrix.service }}
            export MAVEN_OPTS="-Xmx512m"
            mvn test
          fi

      - name: Upload build artifact
        if: steps.changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ${{ matrix.service }}/target/*.jar
          retention-days: 1  # Solo 1 día de retención

  # OPTIMIZACIÓN 4: Reducir paralelismo en Docker builds
  build-docker-images:
    needs: [build-services, set-env]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2  # Solo 2 builds Docker simultáneos
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Build Docker Image - ${{ matrix.service }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if service changed
        id: changed
        run: |
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.service }}/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Extract version
        if: steps.changed.outputs.changed == 'true'
        id: version
        run: |
          if [ -f "${{ matrix.service }}/pom.xml" ]; then
            VERSION=$(grep '<version>' ${{ matrix.service }}/pom.xml | head -n1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="latest"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      # OPTIMIZACIÓN 5: Cache de Docker layers
      - name: Set up Docker Buildx
        if: steps.changed.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        if: steps.changed.outputs.changed == 'true'
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-

      - name: Download build artifact
        if: steps.changed.outputs.changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ./${{ matrix.service }}/target/

      - name: Verify JAR
        if: steps.changed.outputs.changed == 'true'
        run: |
          ls -lah ${{ matrix.service }}/target/

      - name: Login to Docker Hub
        if: steps.changed.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        if: steps.changed.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.set-env.outputs.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # OPTIMIZACIÓN 6: Solo escanear en cambios importantes
      - name: Scan Docker image with Trivy (solo en dev)
        if: steps.changed.outputs.changed == 'true' && needs.set-env.outputs.IMAGE_TAG == 'dev'
        uses: aquasecurity/trivy-action@0.11.2
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.set-env.outputs.IMAGE_TAG }}
          format: table
          exit-code: 0
          vuln-type: 'os,library'
          severity: 'CRITICAL'  # Solo críticos

      # Mover cache
      - name: Move cache
        if: steps.changed.outputs.changed == 'true'
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  validate-charts:
    needs: build-docker-images
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      matrix:
        service:
          - user-service
          - product-service
          - payment-service
          - shipping-service
          - favourite-service
          - api-gateway
          - service-discovery
          - order-service
          - cloud-config
          - proxy-client
    name: Validate ${{ matrix.service }} Helm Chart
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm lint ${{ matrix.service }}
        run: |
          if [ -d "helm/ecommerce/charts/${{ matrix.service }}" ]; then
            helm lint "helm/ecommerce/charts/${{ matrix.service }}" -f "${{ needs.set-env.outputs.VALUES_FILE }}" --set global.targetEnvironment=dev
          fi

  # OPTIMIZACIÓN 7: Deploy simplificado (sin todos los tests)
  deploy-and-test:
    needs: [validate-charts, set-env]
    runs-on: ubuntu-latest
    name: Deploy & Smoke Tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      - name: Create Kind cluster
        run: |
          kind create cluster --name ecommerce-ci --wait 60s

      - name: Detect which services changed and set tags
        id: detect-changes
        run: |
          SERVICE_DISCOVERY_TAG="feature-monitoring"
          CLOUD_CONFIG_TAG="feature-monitoring"
          API_GATEWAY_TAG="feature-monitoring"
          PRODUCT_SERVICE_TAG="feature-monitoring"
          USER_SERVICE_TAG="feature-monitoring"
          PAYMENT_SERVICE_TAG="feature-monitoring"
          SHIPPING_SERVICE_TAG="feature-monitoring"
          FAVOURITE_SERVICE_TAG="feature-hpa"
          ORDER_SERVICE_TAG="feature-monitoring"
          PROXY_CLIENT_TAG="feature-monitoring"
          
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^service-discovery/"; then
              SERVICE_DISCOVERY_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^cloud-config/"; then
              CLOUD_CONFIG_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^api-gateway/"; then
              API_GATEWAY_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^product-service/"; then
              PRODUCT_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^user-service/"; then
              USER_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^payment-service/"; then
              PAYMENT_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^shipping-service/"; then
              SHIPPING_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^favourite-service/"; then
              FAVOURITE_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^order-service/"; then
              ORDER_SERVICE_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^proxy-client/"; then
              PROXY_CLIENT_TAG="${{ needs.set-env.outputs.IMAGE_TAG }}"
            fi
          fi
          
          echo "service-discovery-tag=$SERVICE_DISCOVERY_TAG" >> $GITHUB_OUTPUT
          echo "cloud-config-tag=$CLOUD_CONFIG_TAG" >> $GITHUB_OUTPUT
          echo "api-gateway-tag=$API_GATEWAY_TAG" >> $GITHUB_OUTPUT
          echo "product-service-tag=$PRODUCT_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "user-service-tag=$USER_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "payment-service-tag=$PAYMENT_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "shipping-service-tag=$SHIPPING_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "favourite-service-tag=$FAVOURITE_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "order-service-tag=$ORDER_SERVICE_TAG" >> $GITHUB_OUTPUT
          echo "proxy-client-tag=$PROXY_CLIENT_TAG" >> $GITHUB_OUTPUT

      - name: Helm deploy ecommerce
        run: |
          helm upgrade --install my-ecommerce ./helm/ecommerce \
            -f ${{ needs.set-env.outputs.VALUES_FILE }} \
            --set global.targetEnvironment=dev \
            \
            --set service-discovery.resources={} \
            --set cloud-config.resources={} \
            --set api-gateway.resources={} \
            --set product-service.resources={} \
            --set user-service.resources={} \
            --set payment-service.resources={} \
            --set shipping-service.resources={} \
            --set favourite-service.resources={} \
            --set order-service.resources={} \
            --set proxy-client.resources={} \
            \
            --set service-discovery.hpa.enabled=false \
            --set cloud-config.hpa.enabled=false \
            --set api-gateway.hpa.enabled=false \
            --set product-service.hpa.enabled=false \
            --set user-service.hpa.enabled=false \
            --set payment-service.hpa.enabled=false \
            --set shipping-service.hpa.enabled=false \
            --set favourite-service.hpa.enabled=false \
            --set order-service.hpa.enabled=false \
            --set proxy-client.hpa.enabled=false \
            \
            --set service-discovery.replicaCount=1 \
            --set cloud-config.replicaCount=1 \
            --set api-gateway.replicaCount=1 \
            --set product-service.replicaCount=1 \
            --set user-service.replicaCount=1 \
            --set payment-service.replicaCount=1 \
            --set shipping-service.replicaCount=1 \
            --set favourite-service.replicaCount=1 \
            --set order-service.replicaCount=1 \
            --set proxy-client.replicaCount=1 \
            \
            # ==== TAGS DETECTADOS ====
            --set service-discovery.image.tag=${{ steps.detect-changes.outputs.service-discovery-tag }} \
            --set cloud-config.image.tag=${{ steps.detect-changes.outputs.cloud-config-tag }} \
            --set api-gateway.image.tag=${{ steps.detect-changes.outputs.api-gateway-tag }} \
            --set product-service.image.tag=${{ steps.detect-changes.outputs.product-service-tag }} \
            --set user-service.image.tag=${{ steps.detect-changes.outputs.user-service-tag }} \
            --set payment-service.image.tag=${{ steps.detect-changes.outputs.payment-service-tag }} \
            --set shipping-service.image.tag=${{ steps.detect-changes.outputs.shipping-service-tag }} \
            --set favourite-service.image.tag=${{ steps.detect-changes.outputs.favourite-service-tag }} \
            --set order-service.image.tag=${{ steps.detect-changes.outputs.order-service-tag }} \
            --set proxy-client.image.tag=${{ steps.detect-changes.outputs.proxy-client-tag }}

      # ===== EUREKA & CLOUD CONFIG =====

      - name: Wait for Service Discovery (Eureka)
        run: |
          kubectl wait --for=condition=Ready pod -l app=service-discovery -n dev --timeout=180s || echo "Eureka timeout"
          echo "Waiting 40s for Eureka to fully initialize..."
          sleep 40

      - name: Wait for Cloud Config
        run: |
          kubectl wait --for=condition=Ready pod -l app=cloud-config -n dev --timeout=180s || echo "Cloud Config timeout"
          echo "Waiting 30s for Cloud Config to register with Eureka..."
          sleep 30

      - name: Wait for all other services
        run: |
          kubectl wait --for=condition=Ready pod --all -n dev --timeout=180s || echo "Some pods not ready"
          echo "Waiting 90s for all services to register with Eureka..."
          sleep 90

      - name: Verify deployment status
        run: |
          kubectl get pods -o wide -n dev
          kubectl get svc -n dev
          kubectl get deployments -n dev
          
      - name: Debug Eureka Server
        run: |
          echo "=== Eureka Server Pods ==="
          kubectl get pods -n dev -l app=my-ecommerce-service-discovery
          
          echo "=== Eureka Server Logs ==="
          kubectl logs -n dev -l app=my-ecommerce-service-discovery --tail=50
          
          echo "=== Eureka Server Service ==="
          kubectl get svc -n dev my-ecommerce-service-discovery

      - name: Debug API Gateway Connection to Eureka
        run: |
          echo "=== API Gateway Pods ==="
          kubectl get pods -n dev -l app=my-ecommerce-api-gateway
          
          echo "=== API Gateway Logs (buscar errores de Eureka) ==="
          kubectl logs -n dev -l app=my-ecommerce-api-gateway --tail=100 | grep -i eureka || echo "No Eureka logs found"

      - name: Debug All Services
        run: |
          echo "=== All Pods in dev namespace ==="
          kubectl get pods -n dev -o wide
          
          echo "=== All Services in dev namespace ==="
          kubectl get svc -n dev

      - name: Test Eureka from test pod
        run: |
          kubectl run test-pod -n dev --image=curlimages/curl:latest --restart=Never --command -- sleep 3600
          kubectl wait -n dev --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "=== Test Eureka Health ==="
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-service-discovery.dev.svc.cluster.local:8761/actuator/health
          
          echo "=== Test Eureka Registry ==="
          kubectl exec test-pod -n dev -- curl -s http://my-ecommerce-service-discovery.dev.svc.cluster.local:8761/eureka/apps

      # === Test endpoints ===
      - name: Test API Gateway
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-api-gateway.dev.svc.cluster.local:8080/app/api/products

      - name: Test Shipping Service
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-shipping-service.dev.svc.cluster.local:8600/shipping-service/api/shippings

      - name: Test User Service
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-user-service.dev.svc.cluster.local:8700/user-service/api/users

      - name: Test Product Service
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-product-service.dev.svc.cluster.local:8500/product-service/api/products

      - name: Test Favourite Service
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-favourite-service.dev.svc.cluster.local:8800/favourite-service/api/favourites

      - name: Test Payment Service
        run: |
          kubectl exec test-pod -n dev -- curl -v http://my-ecommerce-payment-service.dev.svc.cluster.local:8400/payment-service/api/payments

      - name: Cleanup test pod
        if: always()
        run: |
          kubectl delete pod test-pod -n dev --ignore-not-found
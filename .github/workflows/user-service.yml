name: User Service CI (Kind + Helm)

on:
  push:
    paths:
      - 'user-service/**'
      - 'helm/user-service/**'
      - '.github/workflows/user-service.yml'
  pull_request:
    paths:
      - 'user-service/**'
      - 'helm/user-service/**'

env:
  HELM_VERSION: 3.12.0
  KIND_VERSION: v0.20.0

jobs:
  ci-kind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Helm
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      # Install Kind
      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: ${{ env.KIND_VERSION }}

      # Create Kind cluster
      - name: Create cluster
        run: |
          kind create cluster --name ci-cluster --wait 60s

      # Helm lint ONLY user-service chart
      - name: Helm lint (user-service)
        run: |
          helm lint ./helm/user-service

      # Render Helm template ONLY user-service
      - name: Render Helm template (user-service)
        run: |
          helm template user-service ./helm/user-service \
            -f ./helm/user-service/values.yaml \
            --set global.targetEnvironment=dev \
            > helm-rendered-user-service.yaml

      # Upload rendered template
      - name: Upload helm template
        uses: actions/upload-artifact@v4
        with:
          name: user-service-rendered-template
          path: helm-rendered-user-service.yaml

      # Deploy user-service into Kind
      - name: Helm install user-service into Kind
        run: |
          kubectl create namespace ecommerce || true
          helm upgrade --install user-service ./helm/user-service \
            -n ecommerce \
            -f ./helm/user-service/values.yaml \
            --set global.targetEnvironment=dev \
            --wait --timeout 3m

      # Verify only user-service pods
      - name: Verify user-service pods
        run: |
          kubectl get pods -n ecommerce
          kubectl wait --for=condition=Ready pod -l app=user-service -n ecommerce --timeout=60s

      # Destroy cluster
      - name: Delete kind cluster
        if: always()
        run: |
          kind delete cluster --name ci-cluster
